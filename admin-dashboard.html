<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelola Tiket - Wahana Tel U</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            padding-bottom: 80px;
        }
        
        /* Navbar */
        .navbar {
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .navbar-brand {
            color: #7b1113 !important;
            font-weight: 700;
            font-size: 1.5rem;
        }
        
        .navbar-nav .nav-link {
            color: #333 !important;
            font-weight: 500;
            margin-right: 1.5rem;
        }
        
        .avatar-circle {
            width: 45px;
            height: 45px;
            background-color: #e85149;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.25rem;
        }
        
        /* Footer */
        .footer {
            background-color: white;
            border-top: 1px solid #e0e0e0;
            padding: 20px 0;
            text-align: center;
            color: #666;
            font-size: 0.875rem;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
        }
        
        /* Main Content */
        .main-content {
            padding: 40px 0;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .page-subtitle {
            color: #666;
            font-size: 0.95rem;
            margin-bottom: 2rem;
        }
        
        /* Info Cards */
        .info-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .info-card-label {
            color: #666;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .info-card-value {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
        }
        
        /* Section Header */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
        }
        
        .btn-tambah {
            background-color: #4f46e5;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            transition: background-color 0.3s ease;
        }
        
        .btn-tambah:hover {
            background-color: #4338ca;
            color: white;
        }
        
        /* Table */
        .table-wrapper {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .table {
            margin-bottom: 0;
            font-size: 0.95rem;
        }
        
        .table thead {
            background-color: #f9f9f9;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .table thead th {
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            padding: 1.25rem;
            border: none;
        }
        
        .table tbody td {
            padding: 1.25rem;
            border-bottom: 1px solid #e0e0e0;
            color: #333;
            vertical-align: middle;
        }
        
        .table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .ticket-id {
            color: #999;
            font-weight: 500;
        }
        
        .ticket-name {
            font-weight: 600;
            color: #333;
        }
        
        .ticket-price {
            font-weight: 600;
            color: #333;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 0.75rem;
        }
        
        .btn-edit {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background-color: #d1fae5;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #059669;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 1.1rem;
            text-decoration: none;
        }
        
        .btn-edit:hover {
            background-color: #a7f3d0;
        }
        
        .btn-delete {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background-color: #fee2e2;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #dc2626;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 1.1rem;
            text-decoration: none;
        }
        
        .btn-delete:hover {
            background-color: #fecaca;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg shadow-sm py-3 fixed-top">
        <div class="container">
        <a class="navbar-brand fw-bold">Wahana Tel-U</a>
        <div class="collapse navbar-collapse justify-content-end" id="navbarNav">

    <!-- Profile Section -->
            <div class="dropdown">
            <a href="#" class="d-flex align-items-center gap-2 text-decoration-none" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <img src="assets/user.jpg" alt="User Photo" class="rounded-circle" width="40" height="40" style="object-fit: cover;">
            </a>
            <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="userDropdown">
                <li><a class="dropdown-item" href="#" id="logoutBtn">Logout</a></li>
            </ul>
            </div>
        </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content container-lg" style="margin-top: 80px;">
        <!-- Page Title -->
        <div class="mb-4">
            <h1 class="page-title">Kelola Tiket</h1>
            <p class="page-subtitle">Kelola dan lihat semua tiket wahana Anda</p>
        </div>

        <!-- Info Cards -->
        <div class="row mb-4">
            <div class="col-lg-4 col-md-6">
                <div class="info-card">
                    <div class="info-card-label">Total Wahana</div>
                    <div class="info-card-value" id="totalWahana">0</div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6">
                <div class="info-card">
                    <div class="info-card-label">Total Kuota</div>
                    <div class="info-card-value" id="totalKuota">0</div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6">
                <div class="info-card">
                    <div class="info-card-label">Tiket Tersedia</div>
                    <div class="info-card-value" id="tiketTersedia">0</div>
                </div>
            </div>
        </div>

        <!-- Section Header -->
        <div class="section-header">
            <h2 class="section-title">Daftar Tiket Wahana</h2>
            <a href="admin-add-ticket.html" class="btn-tambah">
                <span>+</span> Tambah Tiket
            </a>
        </div>

        <!-- Table -->
        <div class="table-wrapper">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 5%;"></th>
                        <th style="width: 15%;">ID</th>
                        <th style="width: 25%;">NAMA</th>
                        <th style="width: 15%;">QUOTA</th>
                        <th style="width: 20%;">HARGA</th>
                        <th style="width: 20%;">AKSI</th>
                    </tr>
                </thead>
                <tbody id="ticketTableBody">
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem; color: #999;">
                            Loading data...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>&copy; 2025 Wahana Tel U. All rights reserved.</p>
    </footer>

    <!-- Error Modal -->
    <div class="modal fade" id="errorModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Error</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="errorMessage"></p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Ambil token dari localStorage untuk autentikasi pengguna
        const token = localStorage.getItem("token");

        // Jika token tidak ditemukan, user belum login â†’ arahkan ke halaman login
        if (!token) {
            alert("Please login first!");
            window.location.href = "login.html";
        }

        // Fungsi untuk mendapatkan nilai dari beberapa kemungkinan nama field (untuk data API yang tidak konsisten)
        //    Contoh: bisa jadi field namanya "ticketName", "name", atau "ticket_name"
        function getFieldValue(ticket, possibleNames) {
            for (let name of possibleNames) {
                if (ticket[name] !== undefined && ticket[name] !== null) {
                    return ticket[name]; // Kembalikan nilai pertama yang ditemukan
                }
            }
            return null; // Jika semua nama field tidak ada
        }

        // Fungsi utama untuk memuat data semua tiket dari API
        function loadTickets() {
            const currentPage = 1; // Halaman saat ini
            const pageSize = 10;   // Jumlah tiket per halaman
            const url = `https://be-e-wallet.ivantans.web.id/ticket?currentPage=${currentPage}&pageSize=${pageSize}`;

            // Panggil API menggunakan fetch
            fetch(url, {
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + token, // Kirim token autentikasi
                    "Content-Type": "application/json"
                }
            })
            .then(res => {
                // Jika respons gagal (misalnya 401 Unauthorized)
                if (!res.ok) {
                    if (res.status === 401) {
                        // Jika token kadaluarsa â†’ hapus token dan arahkan ke login
                        alert("Session expired. Please login again.");
                        localStorage.removeItem("token");
                        window.location.href = "login.html";
                    }
                    // Lempar error agar masuk ke blok catch
                    throw new Error("Failed to load tickets. Status: " + res.status);
                }
                // Jika respons OK, ubah hasil ke format JSON
                return res.json();
            })
            .then(response => {
                // Tangani format data API (beberapa API mungkin menaruh list di tempat berbeda)
                const tickets = response.data?.list || response.data || response || [];

                // Pastikan hasilnya berupa array
                if (!Array.isArray(tickets)) {
                    throw new Error("Invalid response format");
                }

                // Debug: tampilkan struktur objek tiket pertama (opsional)
                if (tickets.length > 0) {
                    console.log("First ticket object:", tickets[0]);
                    console.log("Available fields:", Object.keys(tickets[0]));
                }

                // Hitung statistik tiket
                const totalWahana = tickets.length; // Jumlah total tiket/wahana
                let totalKuota = 0; // Jumlah total kuota tiket

                // Loop semua tiket untuk menghitung total kuota
                tickets.forEach(ticket => {
                    const quota = getFieldValue(ticket, ['ticketQuota', 'quota', 'quotas', 'ticket_quota']) || 0;
                    totalKuota += parseInt(quota) || 0;
                });

                // Tampilkan statistik ke dashboard (card info)
                document.getElementById('totalWahana').textContent = totalWahana;
                document.getElementById('totalKuota').textContent = totalKuota.toLocaleString('id-ID');
                document.getElementById('tiketTersedia').textContent = totalWahana;

                // Dapatkan elemen tabel tempat daftar tiket akan ditampilkan
                const tableBody = document.getElementById('ticketTableBody');
                tableBody.innerHTML = ''; // Kosongkan dulu tabel

                // Jika tidak ada tiket â†’ tampilkan pesan kosong
                if (tickets.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #999;">Belum ada tiket</td></tr>';
                    return;
                }

                // Loop setiap tiket untuk ditampilkan dalam tabel
                tickets.forEach((ticket, index) => {
                    const ticketId = getFieldValue(ticket, ['ticketId', 'id', 'ticket_id']) || (index + 1);
                    const ticketName = getFieldValue(ticket, ['ticketName', 'name', 'ticket_name', 'ticketname']) || '-';
                    const ticketQuota = getFieldValue(ticket, ['ticketQuota', 'quota', 'quotas', 'ticket_quota']) || 0;
                    const ticketPrice = getFieldValue(ticket, ['ticketPrice', 'price', 'ticket_price', 'ticketprice']) || 0;

                    // Format harga menjadi format mata uang Rupiah
                    const formattedPrice = new Intl.NumberFormat('id-ID', {
                        style: 'currency',
                        currency: 'IDR'
                    }).format(parseInt(ticketPrice) || 0);

                    // Buat elemen baris tabel (tr)
                    const row = document.createElement('tr');

                    // Isi HTML untuk setiap baris tiket
                    row.innerHTML = `
                        <td><input type="checkbox" style="cursor: pointer;"></td>
                        <td class="ticket-id">ID: ${String(ticketId).padStart(4, '0')}</td>
                        <td class="ticket-name">${ticketName}</td>
                        <td>${parseInt(ticketQuota) || 0}</td>
                        <td class="ticket-price">${formattedPrice}</td>
                        <td>
                            <div class="action-buttons">
                                <a href="admin-edit-ticket.html?ticketId=${ticketId}" class="btn-edit" title="Edit">âœŽ</a>
                                <a href="admin-delete-ticket.html?ticketId=${ticketId}" class="btn-delete" title="Hapus">ðŸ—‘</a>
                            </div>
                        </td>
                    `;
                    // Tambahkan baris ke tabel
                    tableBody.appendChild(row);
                });
            })
            .catch(err => {
                // Tangani error (misalnya gagal fetch atau format salah)
                console.error("Error:", err);

                // Tampilkan pesan error di tabel
                const tableBody = document.getElementById('ticketTableBody');
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #999;">Error loading data. Please refresh the page.</td></tr>';

                // Tampilkan modal error Bootstrap (jika ada)
                const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
                document.getElementById('errorMessage').textContent = "Failed to load tickets: " + err.message;
                errorModal.show();

                // Sembunyikan modal setelah 3 detik
                setTimeout(() => errorModal.hide(), 3000);
            });
        }

        // Jalankan loadTickets() saat halaman selesai dimuat
        window.addEventListener('load', loadTickets);

        // Fungsi Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('token'); // Hapus token dari localStorage
            window.location.href = 'login.html'; // Arahkan ke halaman login
        });
    </script>

</body>
</html>
