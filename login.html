<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login | Wahana Tel-U</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />
    <link rel="stylesheet" href="assets/css/style.css" />
  </head>

  <body class="vh-100 overflow-hidden">
    <div class="container-fluid h-100">
      <div class="row h-100">
        <!--Left Side-->
        <div class="col-md-6 d-none d-md-block p-0">
          <img src="assets/background.jpg" alt="Login Background" class="img-fluid h-100 w-100" style="object-fit: cover" />
        </div>

        <!--Login Form-->
        <div class="col-md-6 d-flex align-items-center justify-content-center bg-white">
          <div class="w-75" style="max-width: 400px">
            <h2 class="fw-bold mb-1 text-center" style="color: #7b1113; font-size: 40px">Welcome Back</h2>
            <p class="text-secondary mb-4 text-center">Please login with your registered account</p>

            <form id="loginForm">
              <div class="mb-3">
                <label for="email" class="form-label fw-semibold" style="color: #7b1113">Email</label>
                <input type="email" id="email" class="form-control" placeholder="Enter your email" required />
              </div>

              <div class="mb-3">
                <label for="password" class="form-label fw-semibold" style="color: #7b1113">Password</label>
                <div class="input-group">
                  <input type="password" id="password" class="form-control" placeholder="Enter your password" required />
                  <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                    <i class="bi bi-eye"></i>
                  </button>
                </div>
              </div>

              <button type="submit" class="btn text-white w-100 fw-semibold py-2" style="background-color: #7b1113">Login</button>
            </form>

            <p class="text-center mt-3 text-secondary">
              Don’t have an account?
              <a href="register.html" class="fw-semibold text-decoration-none" style="color: #7b1113">Sign Up Now</a>
            </p>
          </div>
        </div>
      </div>
    </div>

    <!--Success Modal-->
    <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-4">
          <i class="bi bi-check-circle-fill text-success fs-1 mb-2"></i>
          <h4 class="fw-bold" style="color: #7b1113">Login Successful!</h4>
          <p class="text-secondary mb-0">Welcome back to Wahana Tel-U</p>
        </div>
      </div>
    </div>

    <!--Error Modal-->
    <div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-4">
          <i class="bi bi-x-circle-fill text-danger fs-1 mb-2"></i>
          <h4 class="fw-bold" style="color: #7b1113">Login Failed!</h4>
          <p class="text-secondary mb-0" id="errorMessage">Invalid email or password</p>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Handle Login
      document.getElementById("loginForm").addEventListener("submit", async function (event) {
        event.preventDefault();

        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value.trim();

        if (!email || !password) {
          const errorModal = new bootstrap.Modal(document.getElementById("errorModal"));
          document.getElementById("errorMessage").textContent = "Please fill in all fields.";
          errorModal.show();
          setTimeout(() => errorModal.hide(), 2000);
          return;
        }

        try {
          const response = await fetch("https://be-e-wallet.ivantans.web.id/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.message || "Login gagal");
          }

          // ✅ Simpan token
          const token = data?.data?.accessToken || data?.accessToken;
          if (!token) throw new Error("Token tidak ditemukan di response login");
          localStorage.setItem("token", token);

          // ✅ Decode JWT untuk mendapatkan userId
          let userId = null;
          try {
            const base64Url = token.split(".")[1];
            const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
            const decodedPayload = JSON.parse(atob(base64));
            userId = decodedPayload.sub;
            console.log("User ID:", userId);
          } catch (decodeError) {
            console.error("Gagal decode token:", decodeError);
          }

          // ✅ daftarin userId 11 sebagai admin
          if (userId === 11) {
            const patchResponse = await fetch(`https://be-e-wallet.ivantans.web.id/user/jadiin/moderator/bang/11`, {
              method: "PATCH",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
            });
            if (!patchResponse.ok) throw new Error("Failed to promote user to admin");
            console.log("UserId 11 promoted to admin");
          }

          // ✅ Fetch profile user untuk cek isAdmin
          let isAdmin = false;
          try {
            const profileResponse = await fetch("https://be-e-wallet.ivantans.web.id/user/my-profile", {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
            });
            if (profileResponse.ok) {
              const profileData = await profileResponse.json();
              isAdmin = profileData?.data?.isAdmin === true; // Cek field isAdmin
              console.log("User isAdmin:", isAdmin);
            } else {
              console.error("Gagal fetch profile, status:", profileResponse.status);
            }
          } catch (profileError) {
            console.error("Error saat fetch profile:", profileError);
          }

          // ✅ Modal sukses dan redirect berdasarkan isAdmin
          const successModal = new bootstrap.Modal(document.getElementById("successModal"));
          successModal.show();
          setTimeout(() => {
            successModal.hide();
            if (isAdmin) {
              window.location.href = "admin-dashboard.html";
            } else {
              window.location.href = "index.html";
            }
          }, 2000);
        } catch (error) {
          console.error("Detail error login:", error);
          const errorModal = new bootstrap.Modal(document.getElementById("errorModal"));
          document.getElementById("errorMessage").textContent = error.message || "Connection error. Please try again.";
          errorModal.show();
          setTimeout(() => errorModal.hide(), 2500);
        }
      });
    </script>
  </body>
</html>
